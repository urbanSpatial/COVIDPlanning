---
title: "CV19 Grant Funding"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: default
    mathjax: null
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(flexdashboard)
library(shinyWidgets)
library(shiny)
# devtools::install_github("walkerke/bsselectR")
library(bsselectR)
library(stringr)
library(leaflet)
library(kableExtra)
library(sf)
library(sparkline)
library(tidyverse)
library(formattable)
library(htmltools)
library(scales)
```

<style>

<!-- All white background -->
body {background-color: #ffffff;}
.tab-content>.dashboard-page-wrapper.active {background-color: #ffffff}

<!-- Text centering -->
h1, .h1, strong, .strong {text-align: center;}
h2 {text-align: center;}
h3 {text-align: center;}
h4 {text-align: center;}

<!-- Dropdown menu -->
<!-- .btn-default:active, .btn-default.active,  -->
<!-- .open>.dropdown-toggle.btn-default, -->
<!-- .btn-default:focus { -->
<!--   background-color: #2780e3; -->
<!-- } -->
.btn-default:active:hover, .btn-default.active:hover, .open>.dropdown-toggle.btn-default:hover, .btn-default:active:focus, .btn-default.active:focus, .open>.dropdown-toggle.btn-default:focus, .btn-default:active.focus, .btn-default.active.focus, .open>.dropdown-toggle.btn-default.focus
 {
  background-color: #2780e3;
  color: white;
  padding: 16px;
  font-size: 16px;
  border: none;
}

.btn-default, .btn-default:active, .btn-default.active, 
.open>.dropdown-toggle.btn-default,
.btn-default:focus, .btn-default:hover
 {
  background-color: #2780e3;
  color: white;
  padding: 16px;
  font-size: 16px;
  border: none;
}
.bootstrap-select.btn-group:not(.input-group-btn), .bootstrap-select.btn-group[class*=col-] {
  margin-left: 0%;
}
.btn-default:active {background-color: #2780e3;}
btn-default:active {background-color: #2780e3;}
.btn-default:visited {background-color: #2780e3;}
btn-default:visited {background-color: #2780e3;}
.btn-default:hover {background-color: #2780e3;}
.dropdown-toggle.btn-default:focus {background-color: #2780e3;}
li.selected.active > a {background-color: #2780e3;}
.dropdown-menu > li > a:focus {background-color: #1967be;}
.dropdown-menu > li > a:hover {background-color: #1967be;}
.dropdown-menu > ul > li.selected.active > a  {background-color: #1967be;}


<!-- leaflet center -->
.leaflet-container {
    margin: auto;
}
leaflet-container {
    margin: auto;
}
.html-widget {
    margin: auto;
}

p {
  margin-right: 150px;
  margin-left: 150px;
}

iframe {
  padding-top: 75px;
}

</style>


```{r data, include=FALSE}
### NEED ALL THE DATA
repo_dir <- "C:/MicaDL/CV19_Grants/cv19grantmaking"
all_long_sf_clean <- readr::read_rds(file.path(repo_dir,"/DATA/all_long_sf_clean.rds"))
sparkline.finish  <- readr::read_rds(file.path(repo_dir,"/DATA/needs_summary_JS_table.rds"))
grantmakingData   <- read.csv(file.path(repo_dir,"DATA/6_1_2020_ERFund_geocodes_MDH.csv"),
                     stringsAsFactors = FALSE) 

Region_county_outline_sf    <- st_read(file.path(repo_dir,
                                                 "/GEOJSON/Region_county_outline_sf.geojson"))
county_vulnerability_grants <- st_read(file.path(repo_dir,
                                                 "/GEOJSON/county_vulnerability_grants.geojson"))
```


<!-- Summary Table Creation -->
<!-- # ```{r include=FALSE} -->
<!-- # State  = "Pennsylvania" -->
<!-- # pa.counties <- c("Bucks County", "Montgomery County", "Chester County", "Delaware County","Philadelphia County") -->
<!-- # nj.counties <- c("Camden County","Burlington County","Atlantic County","Cumberland County","Cape May County") -->
<!-- # pa_dat <- filter(all_long_sf_clean, State=="Pennsylvania" & County %in% pa.counties) -->
<!-- # nj_dat <- filter(all_long_sf_clean, State=="New Jersey" & County %in% nj.counties) -->
<!-- # all_dat.sf <- rbind(pa_dat, nj_dat) %>% st_transform(4326)                -->
<!-- # all_dat <- rbind(st_drop_geometry(pa_dat), st_drop_geometry(nj_dat))                  -->
<!-- # ``` -->


Project Overview
=======================================================================


<h1 style="font-size:32px;"><strong><center>CV-19 Grantmaking strategic planning analytics (Phase 1)</center></strong></h1>
<h2 style="font-size:24px;"><i>An atlas of COVID-19 era need and philanthropic response in the Delaware Valley Region</i></h2>
<br>
<h4>June, 2020</h4>
<br>
<p style="font-size:18px;">Where have Delaware Valley philanthropies allocated emergency COVID-19 resources, and how do those resources align with need? In this, the first Phase of a larger project, a series of strategic planning analytics have been designed to help stakeholders target future grantmaking where it is most in need.</p>
<br>
<p style="font-size:18px;">Visit County Reports above to investigate the geography of grantmaking and need regionally and by county. Visit the About page for more information on this ongoing project.</p>

<h3>Strategic planning overlay map</h3>
<br>
<p style="font-size:18px;">The goal of the map below is to help stakeholders target future grantmaking. Darker shades of blue show Census tracts where there is more relative need, here defined by a Social Vulnerability index, than relative grantmaking. Stakeholders may wish to invest more in these places. Shades of white indicate alignment between relative need and grantmaking. Darker shades of red are places where grantmaking is in relative excess. See the County Reports section for more in-depth strategic planning analysis.</p>
<br>

```{r fig.width=800, fig.height=500}
pal <- colorNumeric("RdBu", NULL)

county_outline <- as(Region_county_outline_sf, "Spatial")
county_outline <- as(county_outline, "SpatialLines")

leaflet(height = 550, width = 800) %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  setView(-75.1652, 39.9526, zoom = 9) %>% 
  addPolygons(data = county_vulnerability_grants,
              stroke = FALSE, 
              smoothFactor = 0.3, 
              fillOpacity = 0.8,
              fillColor = ~pal(alignment),
              popup = ~paste0(County,"<br>",
                    "GEOID: ", GEOID, "<br>",
                    "Alignment: ", alignment),
              group = "Vulnerability") %>%
    addPolylines(data = county_outline, 
                 stroke = TRUE, 
                 color = "black",
                 opacity = 1,
                 weight = 1,
                 fillOpacity = 0,
                 group = "Counties"
  ) %>% 
  addLayersControl(
    overlayGroups = c("Counties", "Vulnerability"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(values = county_vulnerability_grants$alignment, 
            group = "Vulnerability", 
            position = "bottomleft", 
            # pal = pal, 
            colors =c("#CA0020", "#F4A582", "#F7F7F7", "#92C5DE", "#0571B0"),
            labels= c("Sufficient Granting", "","Well Aligned","", "Excess Need"),
            title = "Vulnerability")
```


<br>


```{r}
h3("County grantmaking and need statistics")

formattable::format_table(sparkline.finish, 
  align =c("l","c","c","c","c","c","c","c"),
  list(
    Number=color_bar("#F1A587"),
    Dollars=color_bar("#F3C0AC"),
    Housing_Instability=color_bar("#8BBCD9"),
    Social_Vulnerability=color_bar("#AFD0E3"))) %>%
  
  kable_styling("striped", full_width = F, bootstrap_options = c("striped", "hover", "condensed")) %>%
    add_header_above(c(" " = 1, "Total Granting" = 2, "Average Need" = 2, "Distribution of Need & Resources" = 3),
     color="grey") %>%
    column_spec(1, bold = T, border_right = T) %>%
    column_spec(3, border_right = T) %>%
    column_spec(5, border_right = T) %>%
    column_spec(8, border_right = T) %>%
  htmltools::HTML() %>%
  shiny::div() %>%
  sparkline::spk_add_deps()
```


<br>
<p style="font-size:18px;"> This work was supported by a coalition philanthropic organizations in the Delaware Valley Region and created by the below entities. </p>
<br>
<center><img src="./IMAGES/3logos_ERproject.png" width="600"></center>




County Reports {data-icon="fa-map"}
=======================================================================

<h3>County Level Analysis</h3>


```{r}
county_plots <- c("./REPORTS/Regional.html", "./REPORTS/Atlantic_County.html",
                  "./REPORTS/Bucks_County.html",
                  "./REPORTS/Burlington_County.html", "./REPORTS/Camden_County.html",
                  "./REPORTS/Delaware_County.html", "./REPORTS/Montgomery_County.html", "./REPORTS/Philadelphia_County.html")
names(county_plots) <- str_replace_all(county_plots,
                                      c("\\.html" = "",
                                        "./REPORTS/" = "",
                                        "_" = " "))

# note this only support iframe
bsselect_buildTags <- function(
  choices,
  selected = NULL,
  dropdownAlignRight = FALSE,
  dropupAuto = TRUE,
  header = FALSE,
  liveSearch = FALSE,
  boxWidth = FALSE,
  liveSearchStyle = c("contains", "startsWith"),
  showTick = FALSE,
  size = "auto",
  style = NULL,
  selectWidth = "20%",
  frameHeight = NULL,
  frameWidth = "80%",
  elementId = NULL
) {
  l <- function(x) return(tolower(as.character(x)))
  if (is.null(selected)) {
      sel <- choices[1]
  }
  else {
      index <- match(selected, names(choices))
      sel <- choices[index]
  }
  liveSearchStyle = match.arg(liveSearchStyle, c("contains", "startsWith"))
  tagList(
    # get necessary dependencies minus htmlwidgets.js and bsselect widget binding
    htmlwidgets::getDependency("bsselect", package="bsselectR")[2],
    tags$div(
      style = "width: 100%;",
      tags$div(
        style = paste0("width:", selectWidth,"; float: left; padding-left:20px;"),
        tags$select(
          id = paste0(elementId,"-select"),
          class = "selectpicker",
          `data-dropdown-align-right` = l(dropdownAlignRight),
          `data-dropup-auto` = l(dropupAuto), `data-header` = l(header),
          `data-live-search` = l(liveSearch), `data-live-search-style` = liveSearchStyle,
          `data-show-tick` = l(showTick), `data-width` = l(boxWidth),
          `data-size` = l(size), `data-style` = style,
          bsselectR:::selectOptions(choices, selected)
        )
      ),
      tags$iframe(
        id = paste0(elementId,"-iframe"),
        src  = sel,
        frameborder = "0",
        style = paste0("height:", frameHeight, "; width:", frameWidth,"; float: left;")
      )
    ),
    tags$script(htmltools::HTML(sprintf(
"
$(document).ready(function() {
$('#%s').change(function() {
$('#%s').attr('src', $(this).val())
})
})
",
paste0(elementId,"-select"),
paste0(elementId,"-iframe")
    )))
  )
}

# potentially better to create directly or deconstruct
# bsselect(county_plots,
#          frame_height = NULL,
#          type = "iframe",
#          selected = "Regional",
#          elementId = "dropdown",
#          live_search = TRUE,
#          show_tick = TRUE)

# use our new function instead; note camelCase not snakecase
bsselect_buildTags(county_plots,
         selectWidth = "20%",
         frameHeight = "calc(100vh - 150px)",
         frameWidth = "75%",
         #type = "iframe", #only support iframe
         selected = "Regional",
         elementId = "dropdown",
         liveSearch = TRUE,
         showTick = TRUE)
```  



About 
=======================================================================

<h3>About this project</h3>
<br>
<p style="font-size:18px;">The purpose of this Phase 1 COVID-19 regional data dashboard is to support a more informed and coordinated, regional response among philanthropic funders by providing information on: What the needs are for philanthropic funding, where that need is, who is receiving aid, how & when major relief funds are responding.</p>
<br>
<p style="font-size:18px;">The grants data that appears on this page comes from a host of philanthropies who reported the address, domain of interest and other information for their COVID-19 grantmaking activities. We were able to successfully georeference 90% of these grants. The remainder of the data used was collected from a host of Federal sources (see table below).</p?
<br>
<p style="font-size:18px;">Phase 2 will increase the number of grants in the analysis. We are also developing a more robust and interactive set of planning and mapping tools for this project. Stay tuned!</p>
<br>


Row 
-------------------------------------

### tables{.no-title}

```{r}
h3("Data Sources")

Theme <- c('Housing','Demographics','Employment','Food Insecurity','Child Welfare','Health')
Source <- c('American Community Survey (ACS),\n Homeland Infrastructure Foundation-Level Data (HIFLD)', 'ACS,\nHIFLD',
            'LODES/LEHD,\nBLS Unemployment','ACS,\nUSDA Food Atlas',
            'ACS,\n HIFLD','ACS,\nHIFLD'
            )
Year <- c('2014-2018,\n2019','2014-2018,\n2019','2015,\n2020', '2014-2018,\n2015','2014-2018,\n2019','2014-2018,\n2019')
Link <- c('https://data.census.gov/cedsci/,\n https://gii.dhs.gov/hifld/content/hifld-data-catalog',
          'https://data.census.gov/cedsci/,\n https://gii.dhs.gov/hifld/content/hifld-data-catalog',
          'https://lehd.ces.census.gov/data/, https://www.bls.gov/cew/',
          'https://data.census.gov/cedsci/,
          https://www.ers.usda.gov/data-products/food-access-research-atlas/download-the-data/',
          'https://data.census.gov/cedsci/,\n https://gii.dhs.gov/hifld/content/hifld-data-catalog',
          'https://data.census.gov/cedsci/,\n https://gii.dhs.gov/hifld/content/hifld-data-catalog'
          )
sources <- data.frame(Theme,Source,Year, Link)

kable(sources) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  column_spec(1, width="3cm", border_right = T) %>%
  column_spec(3, width="3cm", border_right = T) 

```

<br>
<p style="font-size:18px;"> This work was supported by a coalition philanthropic organizations in the Delaware Valley Region and created by the below entities. </p>
<br>
<center><img src="./IMAGES/3logos_ERproject.png" width="600"></center>


